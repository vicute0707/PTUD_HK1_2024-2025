package dao;

import entity.SanPham;
import entity.DanhMuc;
import connection.MyConnection;
import java.sql.*;
import java.util.ArrayList;
import java.util.logging.Logger;
import java.util.logging.Level;

public class SanPhamDAO {
    private static final Logger LOGGER = Logger.getLogger(SanPhamDAO.class.getName());
    private MyConnection myConnection;

    public SanPhamDAO() {
        myConnection = new MyConnection();
    }

    public ArrayList<SanPham> getAllSanPham() throws SQLException {
        ArrayList<SanPham> dsSanPham = new ArrayList<>();
        String sql = """
                    SELECT sp.*, dm.tenDM
                    FROM sanpham sp
                    JOIN danhmuc dm ON sp.maDM = dm.maDM
                    WHERE sp.trangThai = 1
                    ORDER BY sp.maSP
                    """;
                    
        try (Connection conn = myConnection.connect();
             PreparedStatement pst = conn.prepareStatement(sql);
             ResultSet rs = pst.executeQuery()) {
            
            while (rs.next()) {
                SanPham sp = new SanPham();
                sp.setMaSP(rs.getString("maSP"));
                sp.setTenSP(rs.getString("tenSP"));
                
                // Set danh mục
                DanhMuc dm = new DanhMuc();
                dm.setMaDM(rs.getString("maDM"));
                dm.setTenDM(rs.getString("tenDM"));
                sp.setDanhmuc(dm);
                
                sp.setSoLuongTonKho(rs.getInt("soLuongTon"));
                sp.setGiaNhap(rs.getDouble("giaNhap"));
                sp.setGiaBan(rs.getDouble("giaBan"));
                sp.setThuongHieu(rs.getString("thuongHieu"));
                
                dsSanPham.add(sp);
            }
            
            LOGGER.info("Đã lấy " + dsSanPham.size() + " sản phẩm từ database");
            return dsSanPham;
            
        } catch (SQLException e) {
            LOGGER.log(Level.SEVERE, "Lỗi khi lấy danh sách sản phẩm từ database", e);
            throw e;
        }
    }

    public String getLastProductId() {
        String sql = "SELECT maSP FROM sanpham ORDER BY maSP DESC LIMIT 1";
        
        try (Connection conn = myConnection.connect();
             PreparedStatement pst = conn.prepareStatement(sql);
             ResultSet rs = pst.executeQuery()) {
            
            if (rs.next()) {
                return rs.getString("maSP");
            }
            return "PRD000";
            
        } catch (SQLException e) {
            LOGGER.log(Level.SEVERE, "Lỗi khi lấy mã sản phẩm cuối cùng", e);
            return "PRD000";
        }
    }

    // Thêm các phương thức CRUD khác tương tự...
}